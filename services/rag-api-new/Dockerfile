FROM python:3.12-slim

WORKDIR /app
ENV PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1

RUN apt-get update && apt-get install -y --no-install-recommends build-essential \
  && rm -rf /var/lib/apt/lists/*

# —Å–Ω–∞—á–∞–ª–∞ —Ç–æ–ª—å–∫–æ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
COPY pyproject.toml ./
COPY uv.lock ./

# —Å—Ç–∞–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ pyproject (–±–µ–∑ GigaChat!)
RUN pip install --no-cache-dir --upgrade pip \
 && pip install --no-cache-dir .

# üëâ –î–û–°–¢–ê–í–õ–Ø–ï–ú GigaChat –ø–æ–≤–µ—Ä—Ö, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –µ–≥–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
# —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å langchain-core, –∫–∞–∫ —É uv
RUN pip install --no-cache-dir --no-deps \
    "gigachat==0.1.43" \
    "langchain-gigachat==0.3.12"

# –∑–∞—Ç–µ–º –∫–æ–¥
COPY . .

EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
